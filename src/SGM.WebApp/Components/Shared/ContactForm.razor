@using System.ComponentModel.DataAnnotations
@rendermode InteractiveServer
@inject IEmailSender EmailSender
@inject ICaptchaService CaptchaService
@inject IJSRuntime JSRuntime

<div class="contact-form">
    <EditForm Model="EmailInput" OnValidSubmit="HandleSubmit" FormName="contact-form" method="post">
        <DataAnnotationsValidator />

        @if (!string.IsNullOrEmpty(StatusMessage))
        {
            var isError = StatusMessage.StartsWith("Error");
            <div class="status-message @(isError ? "error" : "success")">
                <span class="status-icon">@(isError ? "✗" : "✓")</span>
                @StatusMessage
            </div>
        }

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Name</label>
                <InputText @bind-Value="EmailInput.Name" class="form-input" placeholder="Your name..." aria-label="Your name" />
                <ValidationMessage For="@(() => EmailInput.Name)" class="validation-error" />
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <InputText @bind-Value="EmailInput.Email" class="form-input" placeholder="Your email..." aria-label="Your email" />
                <ValidationMessage For="@(() => EmailInput.Email)" class="validation-error" />
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Subject</label>
            <InputText @bind-Value="EmailInput.Subject" class="form-input" placeholder="Subject..." aria-label="Subject" />
            <ValidationMessage For="@(() => EmailInput.Subject)" class="validation-error" />
        </div>

        <div class="form-group">
            <label class="form-label">Message</label>
            <InputTextArea @bind-Value="EmailInput.Message" class="form-input form-textarea" rows="5" placeholder="Your message..." />
            <ValidationMessage For="@(() => EmailInput.Message)" class="validation-error" />
        </div>

        <input type="hidden" id="recaptcha_token" name="recaptcha_token" @bind="RecaptchaToken" />

        <button type="submit" class="btn btn-primary btn-glow" disabled="@IsSubmitting">
            @if (IsSubmitting)
            {
                <span class="btn-loading"></span>
                <span>Sending...</span>
            }
            else
            {
                <span>Send Message</span>
            }
        </button>
    </EditForm>
</div>

@code {
    [Parameter]
    public string CaptchaSiteKey { get; set; } = string.Empty;

    private EmailInputModel EmailInput { get; set; } = new();

    private string? StatusMessage { get; set; }
    private string RecaptchaToken { get; set; } = string.Empty;
    private bool IsSubmitting { get; set; }

    private async Task HandleSubmit()
    {
        IsSubmitting = true;
        StatusMessage = null;

        try
        {
            // Get reCAPTCHA token from JavaScript
            RecaptchaToken = await JSRuntime.InvokeAsync<string>("getRecaptchaToken", CaptchaSiteKey);

            if (string.IsNullOrEmpty(RecaptchaToken))
            {
                StatusMessage = "Error: Could not verify reCAPTCHA";
                return;
            }

            var isHuman = await CaptchaService.VerifyCaptchaAsync(RecaptchaToken);

            if (!isHuman)
            {
                StatusMessage = "Error: failed reCAPTCHA check";
                return;
            }

            var message = $"""
                <p><b>{EmailInput.Name}</b> - {EmailInput.Email}</p>
                <p>{EmailInput.Message}</p>
                """;

            var sentMail = await EmailSender.SendMailAsync("suxrobgm@gmail.com", EmailInput.Subject!, message);

            StatusMessage = sentMail ? "Your message has been sent successfully" : "Error: could not send email";

            if (sentMail)
            {
                EmailInput = new EmailInputModel();
            }
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    public class EmailInputModel
    {
        [Required(ErrorMessage = "Name is required")]
        public string? Name { get; set; }

        [Required(ErrorMessage = "Subject is required")]
        public string? Subject { get; set; }

        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        public string? Email { get; set; }

        [Required(ErrorMessage = "Message is required")]
        public string? Message { get; set; }
    }
}
